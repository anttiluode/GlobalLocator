<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoChallenge: Ultimate Edition</title>
    
    <!-- Leaflet for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;700&display=swap');

        :root {
            /* Dark theme (brightened) */
            --dark-bg: #1a1a2e;
            --dark-darker-bg: #16213e;
            --dark-text: #eee8f5;
            --dark-hud-bg: rgba(26, 26, 46, 0.9);
            --dark-glass-bg: rgba(255, 255, 255, 0.08);
            --dark-glass-border: rgba(255, 255, 255, 0.15);
            --dark-accent: #00f5ff;
            --dark-success: #39ff14;
            --dark-danger: #ff073a;
            --dark-warning: #ffc107;
            --dark-gold: #ffd700;
            --dark-purple: #bf00ff;
            
            /* Light theme */
            --light-bg: #f0f2f5;
            --light-darker-bg: #e3e7ea;
            --light-text: #2c3e50;
            --light-hud-bg: rgba(255, 255, 255, 0.9);
            --light-glass-bg: rgba(255, 255, 255, 0.6);
            --light-glass-border: rgba(0, 0, 0, 0.1);
            --light-accent: #3498db;
            --light-success: #27ae60;
            --light-danger: #e74c3c;
            --light-warning: #f39c12;
            --light-gold: #f1c40f;
            --light-purple: #8e44ad;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Exo 2', sans-serif;
            overflow: hidden;
            height: 100vh;
            transition: all 0.5s ease;
            cursor: crosshair;
        }

        /* Dark theme styles */
        body.dark-theme {
            background: linear-gradient(135deg, var(--dark-darker-bg) 0%, var(--dark-bg) 100%);
            color: var(--dark-text);
        }

        body.dark-theme .bg-animation {
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 245, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(57, 255, 20, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(191, 0, 255, 0.12) 0%, transparent 50%);
        }

        /* Light theme styles */
        body.light-theme {
            background: linear-gradient(135deg, var(--light-bg) 0%, var(--light-darker-bg) 100%);
            color: var(--light-text);
        }

        body.light-theme .bg-animation {
            background: 
                radial-gradient(circle at 20% 50%, rgba(52, 152, 219, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(39, 174, 96, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(155, 89, 182, 0.08) 0%, transparent 50%);
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            animation: bgShift 20s ease-in-out infinite;
        }

        @keyframes bgShift {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-10px) translateY(-10px); }
            50% { transform: translateX(10px) translateY(10px); }
            75% { transform: translateX(-5px) translateY(15px); }
        }

        /* Glass morphism UI */
        .glass {
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .dark-theme .glass {
            background: var(--dark-glass-bg);
            border: 1px solid var(--dark-glass-border);
        }

        .light-theme .glass {
            background: var(--light-glass-bg);
            border: 1px solid var(--light-glass-border);
        }

        .neon-text {
            font-family: 'Orbitron', monospace;
            text-shadow: 
                0 0 5px currentColor,
                0 0 10px currentColor,
                0 0 15px currentColor;
            animation: neonGlow 2s ease-in-out infinite alternate;
        }

        @keyframes neonGlow {
            from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px currentColor; }
            to { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; }
        }

        /* Main containers */
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
            cursor: crosshair;
        }

        #map-container.loaded {
            opacity: 1;
        }

        /* Custom crosshair cursor */
        .leaflet-container {
            cursor: crosshair !important;
        }

        /* HUD Elements */
        .hud {
            position: absolute;
            z-index: 1000;
            padding: 15px 25px;
            transition: all 0.3s ease;
        }

        #mode-controls {
            top: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        #target-display {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            min-width: 400px;
        }

        #target-name {
            font-size: 2.5em;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .dark-theme #target-name {
            color: var(--dark-accent);
        }

        .light-theme #target-name {
            color: var(--light-accent);
        }

        #game-stats {
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 1.2em;
        }

        #timer-display {
            bottom: 20px;
            right: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 3em;
            font-weight: 700;
            text-align: center;
            min-width: 120px;
        }

        .dark-theme #timer-display {
            color: var(--dark-success);
        }

        .light-theme #timer-display {
            color: var(--light-success);
        }

        #timer-display.warning {
            animation: pulse 1s infinite;
        }

        .dark-theme #timer-display.warning {
            color: var(--dark-danger);
        }

        .light-theme #timer-display.warning {
            color: var(--light-danger);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Achievements Panel */
        #achievements-panel {
            top: 20px;
            right: 20px;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        .achievement {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .achievement.unlocked {
            animation: achievementUnlock 0.8s ease-out;
        }

        .dark-theme .achievement.unlocked {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--dark-gold);
        }

        .light-theme .achievement.unlocked {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid var(--light-gold);
        }

        .dark-theme .achievement.locked {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0.6;
        }

        .light-theme .achievement.locked {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            opacity: 0.6;
        }

        @keyframes achievementUnlock {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Multiplier Display */
        #multiplier-display {
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            text-align: center;
            font-family: 'Orbitron', monospace;
            font-size: 1.5em;
            font-weight: 700;
        }

        .dark-theme #multiplier-display {
            color: var(--dark-purple);
        }

        .light-theme #multiplier-display {
            color: var(--light-purple);
        }

        #multiplier-display.active {
            animation: multiplierPulse 0.5s ease-out;
        }

        @keyframes multiplierPulse {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.3); }
            100% { transform: translateY(-50%) scale(1); }
        }

        /* Controls */
        .control-btn, .control-select {
            border-radius: 8px;
            padding: 10px 15px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid;
        }

        .dark-theme .control-btn, .dark-theme .control-select {
            background: var(--dark-glass-bg);
            border-color: var(--dark-glass-border);
            color: var(--dark-text);
        }

        .light-theme .control-btn, .light-theme .control-select {
            background: var(--light-glass-bg);
            border-color: var(--light-glass-border);
            color: var(--light-text);
        }

        .control-btn:hover, .control-select:hover {
            transform: translateY(-2px);
        }

        .dark-theme .control-btn:hover, .dark-theme .control-select:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--dark-accent);
            box-shadow: 0 0 15px var(--dark-accent);
        }

        .light-theme .control-btn:hover, .light-theme .control-select:hover {
            background: rgba(255, 255, 255, 0.8);
            border-color: var(--light-accent);
            box-shadow: 0 0 15px var(--light-accent);
        }

        /* Lives System */
        #lives-display {
            display: flex;
            gap: 5px;
            align-items: center;
            font-size: 1.5em;
        }

        .life-heart {
            transition: all 0.3s ease;
        }

        .life-heart.lost {
            opacity: 0.3;
            transform: scale(0.8);
        }

        /* Overlays */
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            text-align: center;
            min-width: 450px;
            padding: 40px;
        }

        .overlay h1 {
            font-family: 'Orbitron', monospace;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .dark-theme .overlay h1 {
            color: var(--dark-accent);
        }

        .light-theme .overlay h1 {
            color: var(--light-accent);
        }

        .overlay button {
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dark-theme .overlay button {
            background: linear-gradient(45deg, var(--dark-accent), #bf00ff);
        }

        .light-theme .overlay button {
            background: linear-gradient(45deg, var(--light-accent), #8e44ad);
        }

        .overlay button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .loading-animation {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .dark-theme .loading-animation {
            border-top: 3px solid var(--dark-accent);
        }

        .light-theme .loading-animation {
            border-top: 3px solid var(--light-accent);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .score-change {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', monospace;
            font-size: 2em;
            font-weight: 700;
            pointer-events: none;
            z-index: 1500;
            animation: scoreFloat 2s ease-out forwards;
        }

        .dark-theme .score-change.score-positive { color: var(--dark-success); }
        .dark-theme .score-change.score-negative { color: var(--dark-danger); }
        .light-theme .score-change.score-positive { color: var(--light-success); }
        .light-theme .score-change.score-negative { color: var(--light-danger); }

        @keyframes scoreFloat {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -150px) scale(1.5); }
        }

        .highlight-score {
            font-weight: bold;
        }

        .dark-theme .highlight-score {
            color: var(--dark-warning);
        }

        .light-theme .highlight-score {
            color: var(--light-warning);
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 50px;
            right: -400px;
            z-index: 3000;
            padding: 20px 25px;
            border-radius: 12px;
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            animation: slideInOut 4s ease-in-out;
            min-width: 350px;
        }

        .dark-theme .achievement-toast {
            background: linear-gradient(45deg, var(--dark-gold), var(--dark-purple));
            color: white;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .light-theme .achievement-toast {
            background: linear-gradient(45deg, var(--light-gold), var(--light-purple));
            color: white;
            box-shadow: 0 10px 30px rgba(241, 196, 15, 0.3);
        }

        @keyframes slideInOut {
            0%, 100% { right: -400px; }
            15%, 85% { right: 20px; }
        }

        /* Share Button */
        .share-btn {
            background: linear-gradient(45deg, #1da1f2, #1991db);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 161, 242, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #target-name { font-size: 1.8em; }
            #timer-display { font-size: 2em; }
            .overlay { min-width: 90vw; padding: 20px; }
            #mode-controls { flex-direction: column; align-items: flex-start; }
            #achievements-panel { display: none; }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="bg-animation"></div>
    
    <div id="game-container">
        <!-- Leaflet Map Container -->
        <div id="map-container"></div>
        
        <!-- HUD Elements -->
        <div id="mode-controls" class="hud glass">
            <button id="theme-toggle" class="control-btn">☀️ Day Mode</button>
            <select id="game-mode" class="control-select">
                <option value="countries">World Countries</option>
                <option value="us-states">US States</option>
                <option value="world-cities">Major Cities</option>
                <option value="european-countries">European Countries</option>
                <option value="asian-countries">Asian Countries</option>
            </select>
            <select id="difficulty" class="control-select">
                <option value="easy">Easy (45s)</option>
                <option value="medium" selected>Medium (30s)</option>
                <option value="hard">Hard (15s)</option>
                <option value="extreme">EXTREME (8s)</option>
            </select>
            <button id="audio-toggle" class="control-btn">🔊 Audio</button>
        </div>

        <div id="target-display" class="hud glass">
            <div id="target-name" class="neon-text">Loading...</div>
        </div>

        <div id="game-stats" class="hud glass">
            <div>Score: <span id="current-score" class="neon-text highlight-score">10000</span></div>
            <div>High Score: <span id="high-score" class="highlight-score">0</span></div>
            <div>Round: <span id="round-counter">1</span></div>
            <div>Streak: <span id="streak-counter">0</span></div>
            <div id="lives-display">
                Lives: <span id="lives-hearts">❤️❤️❤️</span>
            </div>
        </div>

        <div id="multiplier-display" class="hud glass">
            <div>Multiplier</div>
            <div id="multiplier-value" class="neon-text">1x</div>
        </div>

        <div id="achievements-panel" class="hud glass">
            <h3 style="margin-bottom: 10px; font-family: 'Orbitron', monospace;">Achievements</h3>
            <div id="achievements-list"></div>
        </div>

        <div id="timer-display" class="hud glass neon-text">30</div>
    </div>

    <!-- Overlays -->
    <div id="loading-screen" class="overlay glass">
        <h1 class="neon-text">Loading Earth Data...</h1>
        <div class="loading-animation"></div>
        <p id="loading-status">Initializing...</p>
    </div>

    <div id="game-over-screen" class="overlay glass" style="display: none;">
        <h1 class="neon-text">Game Over!</h1>
        <p style="font-size: 1.5em; margin: 20px 0;">Final Score: <span id="final-score" class="neon-text highlight-score">0</span></p>
        <p id="high-score-message" class="highlight-score" style="font-weight: bold; display: none;">🚀 NEW HIGH SCORE! 🚀</p>
        <div id="final-achievements" style="margin: 20px 0;"></div>
        <button id="restart-btn">Play Again</button>
        <button id="mode-change-btn">Change Mode</button>
        <button id="share-score-btn" class="share-btn">Share Score</button>
    </div>

    <div id="result-overlay" class="overlay glass" style="display: none;">
        <h2 id="result-distance" class="neon-text">0 km away</h2>
        <p id="result-score-text" style="font-size: 1.3em; margin: 15px 0;">Score: +0</p>
        <p id="result-accuracy">Accuracy: 0%</p>
        <button id="next-round-btn">Next Target</button>
        <button id="skip-round-btn">Skip (-2000)</button>
    </div>

    <!-- Ambient Audio -->
    <audio id="ambient-audio" loop>
        <source src="https://cdn.pixabay.com/audio/2022/10/18/audio_1618779998.mp3" type="audio/mpeg">
    </audio>

    <script>
        // === GAME CONFIGURATION ===
        const CONFIG = {
            STARTING_SCORE: 10000,
            MAX_SCORE_PER_ROUND: 5000,
            SKIP_PENALTY: 2000,
            WRONG_PENALTY: 3000,
            STARTING_LIVES: 3,
            DIFFICULTY_SETTINGS: {
                easy: { time: 45, multiplier: 0.8, wrongPenalty: 2000 },
                medium: { time: 30, multiplier: 1.0, wrongPenalty: 3000 },
                hard: { time: 15, multiplier: 1.5, wrongPenalty: 4000 },
                extreme: { time: 8, multiplier: 2.0, wrongPenalty: 5000 }
            }
        };

        // === ACHIEVEMENTS SYSTEM ===
        const ACHIEVEMENTS = [
            { id: 'first_correct', name: 'First Blood', desc: 'Get your first correct guess', icon: '🎯', unlocked: false, points: 500 },
            { id: 'streak_5', name: 'Hot Streak', desc: 'Get 5 correct in a row', icon: '🔥', unlocked: false, points: 1000 },
            { id: 'streak_10', name: 'Unstoppable', desc: 'Get 10 correct in a row', icon: '⚡', unlocked: false, points: 2500 },
            { id: 'perfect_5', name: 'Sharpshooter', desc: 'Get 5 perfect scores (100% accuracy)', icon: '🏹', unlocked: false, points: 2000 },
            { id: 'speed_demon', name: 'Speed Demon', desc: 'Answer correctly in under 3 seconds', icon: '💨', unlocked: false, points: 1500 },
            { id: 'survivor', name: 'Survivor', desc: 'Reach round 20', icon: '🏆', unlocked: false, points: 3000 },
            { id: 'high_roller', name: 'High Roller', desc: 'Reach 50,000 points', icon: '💎', unlocked: false, points: 5000 },
            { id: 'globe_trotter', name: 'Globe Trotter', desc: 'Play all game modes', icon: '🌍', unlocked: false, points: 2000 },
            { id: 'accuracy_master', name: 'Precision Master', desc: 'Maintain 90% accuracy for 10 rounds', icon: '🎪', unlocked: false, points: 4000 },
            { id: 'comeback_king', name: 'Comeback King', desc: 'Score 1000+ points with 1 life left', icon: '👑', unlocked: false, points: 3500 }
        ];

        // === GAME STATE ===
        let gameState = {
            totalScore: CONFIG.STARTING_SCORE,
            currentLocation: null,
            gameMode: 'countries',
            difficulty: 'medium',
            round: 1,
            streak: 0,
            lives: CONFIG.STARTING_LIVES,
            multiplier: 1,
            perfectStreak: 0,
            totalCorrect: 0,
            totalGuesses: 0,
            accuracyHistory: [],
            playedModes: ['countries'],
            isAudioEnabled: true,
            isDarkTheme: true,
            timerInterval: null,
            timeLeft: 30,
            roundStartTime: null,
            achievements: [...ACHIEVEMENTS]
        };

        // === DATA STORAGE ===
        let gameData = {
            countries: [],
            usStates: [
                {name: "Alabama", coords: [32.806671, -86.79113]},
                {name: "Alaska", coords: [61.370716, -152.404419]},
                {name: "Arizona", coords: [33.729759, -111.431221]},
                {name: "Arkansas", coords: [34.969704, -92.373123]},
                {name: "California", coords: [36.116203, -119.681564]},
                {name: "Colorado", coords: [39.059811, -105.311104]},
                {name: "Connecticut", coords: [41.597782, -72.755371]},
                {name: "Delaware", coords: [39.318523, -75.507141]},
                {name: "Florida", coords: [27.766279, -81.686783]},
                {name: "Georgia", coords: [33.040619, -83.643074]},
                {name: "Hawaii", coords: [21.094318, -157.498337]},
                {name: "Idaho", coords: [44.240459, -114.478828]},
                {name: "Illinois", coords: [40.349457, -88.986137]},
                {name: "Indiana", coords: [39.849426, -86.258278]},
                {name: "Iowa", coords: [42.011539, -93.210526]},
                {name: "Kansas", coords: [38.5266, -96.726486]},
                {name: "Kentucky", coords: [37.66814, -84.670067]},
                {name: "Louisiana", coords: [31.169546, -91.867805]},
                {name: "Maine", coords: [44.693947, -69.381927]},
                {name: "Maryland", coords: [39.063946, -76.802101]},
                {name: "Massachusetts", coords: [42.230171, -71.530106]},
                {name: "Michigan", coords: [43.326618, -84.536095]},
                {name: "Minnesota", coords: [45.694454, -93.900192]},
                {name: "Mississippi", coords: [32.741646, -89.678696]},
                {name: "Missouri", coords: [38.456085, -92.288368]},
                {name: "Montana", coords: [46.921925, -110.454353]},
                {name: "Nebraska", coords: [41.12537, -98.268082]},
                {name: "Nevada", coords: [38.313515, -117.055374]},
                {name: "New Hampshire", coords: [43.452492, -71.563896]},
                {name: "New Jersey", coords: [40.298904, -74.521011]},
                {name: "New Mexico", coords: [34.840515, -106.248482]},
                {name: "New York", coords: [42.165726, -74.948051]},
                {name: "North Carolina", coords: [35.630066, -79.806419]},
                {name: "North Dakota", coords: [47.528912, -99.784012]},
                {name: "Ohio", coords: [40.388783, -82.764915]},
                {name: "Oklahoma", coords: [35.565342, -96.928917]},
                {name: "Oregon", coords: [44.572021, -122.070938]},
                {name: "Pennsylvania", coords: [40.590752, -77.209755]},
                {name: "Rhode Island", coords: [41.680893, -71.51178]},
                {name: "South Carolina", coords: [33.856892, -80.945007]},
                {name: "South Dakota", coords: [44.299782, -99.438828]},
                {name: "Tennessee", coords: [35.747845, -86.692345]},
                {name: "Texas", coords: [31.054487, -97.563461]},
                {name: "Utah", coords: [40.150032, -111.862434]},
                {name: "Vermont", coords: [44.045876, -72.710686]},
                {name: "Virginia", coords: [37.769337, -78.169968]},
                {name: "Washington", coords: [47.400902, -121.490494]},
                {name: "West Virginia", coords: [38.491226, -80.954453]},
                {name: "Wisconsin", coords: [44.268543, -89.616508]},
                {name: "Wyoming", coords: [42.755966, -107.30249]}
            ],
            worldCities: [
                {name: "Tokyo", coords: [35.6762, 139.6503]},
                {name: "New York", coords: [40.7128, -74.0060]},
                {name: "London", coords: [51.5074, -0.1278]},
                {name: "Paris", coords: [48.8566, 2.3522]},
                {name: "Sydney", coords: [-33.8688, 151.2093]},
                {name: "Moscow", coords: [55.7558, 37.6176]},
                {name: "Beijing", coords: [39.9042, 116.4074]},
                {name: "Mumbai", coords: [19.0760, 72.8777]},
                {name: "São Paulo", coords: [-23.5505, -46.6333]},
                {name: "Cairo", coords: [30.0444, 31.2357]},
                {name: "Buenos Aires", coords: [-34.6118, -58.3960]},
                {name: "Lagos", coords: [6.5244, 3.3792]},
                {name: "Bangkok", coords: [13.7563, 100.5018]},
                {name: "Istanbul", coords: [41.0082, 28.9784]},
                {name: "Mexico City", coords: [19.4326, -99.1332]},
                {name: "Los Angeles", coords: [34.0522, -118.2437]},
                {name: "Berlin", coords: [52.5200, 13.4050]},
                {name: "Madrid", coords: [40.4168, -3.7038]},
                {name: "Rome", coords: [41.9028, 12.4964]},
                {name: "Toronto", coords: [43.6532, -79.3832]}
            ],
            europeanCountries: [],
            asianCountries: []
        };

        // === LEAFLET SETUP ===
        let leafletMap;
        let guessMarker, answerMarker, resultLine;
        let darkTileLayer, lightTileLayer;

        // === UI ELEMENTS ===
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingStatus: document.getElementById('loading-status'),
            gameOverScreen: document.getElementById('game-over-screen'),
            resultOverlay: document.getElementById('result-overlay'),
            mapContainer: document.getElementById('map-container'),
            ambientAudio: document.getElementById('ambient-audio'),
            
            // Controls
            themeToggle: document.getElementById('theme-toggle'),
            gameModeSelect: document.getElementById('game-mode'),
            difficultySelect: document.getElementById('difficulty'),
            audioToggle: document.getElementById('audio-toggle'),
            
            // Display
            targetName: document.getElementById('target-name'),
            currentScore: document.getElementById('current-score'),
            highScore: document.getElementById('high-score'),
            roundCounter: document.getElementById('round-counter'),
            streakCounter: document.getElementById('streak-counter'),
            livesHearts: document.getElementById('lives-hearts'),
            multiplierValue: document.getElementById('multiplier-value'),
            multiplierDisplay: document.getElementById('multiplier-display'),
            timerDisplay: document.getElementById('timer-display'),
            achievementsList: document.getElementById('achievements-list'),
            
            // Results
            resultDistance: document.getElementById('result-distance'),
            resultScoreText: document.getElementById('result-score-text'),
            resultAccuracy: document.getElementById('result-accuracy'),
            nextRoundBtn: document.getElementById('next-round-btn'),
            skipRoundBtn: document.getElementById('skip-round-btn'),
            
            // Game over
            finalScore: document.getElementById('final-score'),
            highScoreMessage: document.getElementById('high-score-message'),
            finalAchievements: document.getElementById('final-achievements'),
            restartBtn: document.getElementById('restart-btn'),
            modeChangeBtn: document.getElementById('mode-change-btn'),
            shareScoreBtn: document.getElementById('share-score-btn')
        };

        // === LEAFLET INITIALIZATION ===
        function initLeaflet() {
            leafletMap = L.map('map-container', { 
                zoomControl: true,
                maxZoom: 18,
                minZoom: 2
            }).setView([20, 0], 2);
            
            leafletMap.zoomControl.setPosition('bottomleft');
            
            darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '© CartoDB'
            });
            
            lightTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '© CartoDB'
            });
            
            if (gameState.isDarkTheme) {
                leafletMap.addLayer(darkTileLayer);
            } else {
                leafletMap.addLayer(lightTileLayer);
            }
            
            leafletMap.on('click', (e) => {
                if (!gameState.currentLocation) return;
                handleGuess(e.latlng);
            });
        }
        
        // === DATA LOADING ===
        async function loadGameData() {
            try {
                elements.loadingStatus.textContent = 'Fetching latest country data...';
                
                const response = await fetch('https://raw.githubusercontent.com/mledoze/countries/master/countries.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                gameData.countries = data
                    .filter(c => c.name.common && c.latlng && c.latlng.length === 2 && c.independent)
                    .map(c => ({
                        name: c.name.common,
                        coords: c.latlng
                    }));

                // Filter for European countries from the full list
                const europeanCountryNames = ['Albania', 'Andorra', 'Austria', 'Belarus', 'Belgium', 'Bosnia and Herzegovina', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Iceland', 'Ireland', 'Italy', 'Latvia', 'Liechtenstein', 'Lithuania', 'Luxembourg', 'Malta', 'Moldova', 'Monaco', 'Montenegro', 'Netherlands', 'North Macedonia', 'Norway', 'Poland', 'Portugal', 'Romania', 'San Marino', 'Serbia', 'Slovakia', 'Slovenia', 'Spain', 'Sweden', 'Switzerland', 'Ukraine', 'United Kingdom', 'Vatican City'];
                gameData.europeanCountries = gameData.countries.filter(c => europeanCountryNames.includes(c.name));
                
                // Filter for Asian countries from the full list
                const asianCountryNames = ['Afghanistan', 'Armenia', 'Azerbaijan', 'Bahrain', 'Bangladesh', 'Bhutan', 'Brunei', 'Cambodia', 'China', 'Georgia', 'India', 'Indonesia', 'Iran', 'Iraq', 'Israel', 'Japan', 'Jordan', 'Kazakhstan', 'Kuwait', 'Kyrgyzstan', 'Laos', 'Lebanon', 'Malaysia', 'Maldives', 'Mongolia', 'Myanmar', 'Nepal', 'North Korea', 'Oman', 'Pakistan', 'Palestine', 'Philippines', 'Qatar', 'Russia', 'Saudi Arabia', 'Singapore', 'South Korea', 'Sri Lanka', 'Syria', 'Taiwan', 'Tajikistan', 'Thailand', 'Timor-Leste', 'Turkey', 'Turkmenistan', 'United Arab Emirates', 'Uzbekistan', 'Vietnam', 'Yemen'];
                gameData.asianCountries = gameData.countries.filter(c => asianCountryNames.includes(c.name));

                elements.loadingStatus.textContent = 'Data loaded!';
                
            } catch (error) {
                console.error('Error loading dynamic data:', error);
                elements.loadingStatus.textContent = 'Using reliable offline data...';
                
                // Fallback to a smaller, hardcoded list if the fetch fails
                gameData.countries = [
                    {name: "United States", coords: [39.8283, -98.5795]}, {name: "China", coords: [35.8617, 104.1954]},
                    {name: "Russia", coords: [61.5240, 105.3188]}, {name: "Brazil", coords: [-14.2350, -51.9253]},
                    {name: "Australia", coords: [-25.2744, 133.7751]}, {name: "Canada", coords: [56.1304, -106.3468]},
                    {name: "India", coords: [20.5937, 78.9629]}, {name: "Argentina", coords: [-38.4161, -63.6167]},
                    {name: "Mexico", coords: [23.6345, -102.5528]}, {name: "South Africa", coords: [-30.5595, 22.9375]},
                    {name: "United Kingdom", coords: [55.3781, -3.4360]}, {name: "France", coords: [46.2276, 2.2137]},
                    {name: "Germany", coords: [51.1657, 10.4515]}, {name: "Japan", coords: [36.2048, 138.2529]},
                    {name: "Italy", coords: [41.8719, 12.5674]}, {name: "Spain", coords: [40.4637, -3.7492]},
                    {name: "Turkey", coords: [38.9637, 35.2433]}, {name: "Iran", coords: [32.4279, 53.6880]},
                    {name: "Egypt", coords: [26.0975, 31.4735]}, {name: "Nigeria", coords: [9.0765, 8.6753]},
                    {name: "Indonesia", coords: [-0.7893, 113.9213]}, {name: "Thailand", coords: [15.8700, 100.9925]},
                    {name: "Kazakhstan", coords: [48.0196, 66.9237]}, {name: "Algeria", coords: [28.0339, 1.6596]},
                    {name: "Norway", coords: [60.4720, 8.4689]}
                ];
                gameData.europeanCountries = gameData.countries.filter(c => ['United Kingdom', 'France', 'Germany', 'Italy', 'Spain', 'Norway'].includes(c.name));
                gameData.asianCountries = gameData.countries.filter(c => ['China', 'India', 'Japan', 'Turkey', 'Iran', 'Indonesia', 'Thailand', 'Kazakhstan'].includes(c.name));
            }
        }


        // === ACHIEVEMENTS SYSTEM ===
        function checkAchievements() {
            const unlockedThisRound = [];
            
            gameState.achievements.forEach(achievement => {
                if (achievement.unlocked) return;
                
                let shouldUnlock = false;
                
                switch (achievement.id) {
                    case 'first_correct': shouldUnlock = gameState.totalCorrect >= 1; break;
                    case 'streak_5': shouldUnlock = gameState.streak >= 5; break;
                    case 'streak_10': shouldUnlock = gameState.streak >= 10; break;
                    case 'perfect_5': shouldUnlock = gameState.perfectStreak >= 5; break;
                    case 'speed_demon':
                        const responseTime = Date.now() - gameState.roundStartTime;
                        shouldUnlock = responseTime < 3000 && gameState.totalCorrect > 0;
                        break;
                    case 'survivor': shouldUnlock = gameState.round >= 20; break;
                    case 'high_roller': shouldUnlock = gameState.totalScore >= 50000; break;
                    case 'globe_trotter': shouldUnlock = gameState.playedModes.length >= 5; break;
                    case 'accuracy_master':
                        if (gameState.accuracyHistory.length >= 10) {
                            const recentAccuracy = gameState.accuracyHistory.slice(-10);
                            const avgAccuracy = recentAccuracy.reduce((a, b) => a + b, 0) / recentAccuracy.length;
                            shouldUnlock = avgAccuracy >= 90;
                        }
                        break;
                    case 'comeback_king': shouldUnlock = gameState.lives === 1 && gameState.totalScore >= 1000; break;
                }
                
                if (shouldUnlock) {
                    achievement.unlocked = true;
                    gameState.totalScore += achievement.points;
                    unlockedThisRound.push(achievement);
                    showAchievementToast(achievement);
                    saveAchievements();
                }
            });
            
            updateAchievementsDisplay();
            return unlockedThisRound;
        }

        function showAchievementToast(achievement) {
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `
                <div style="font-size: 1.5em; margin-bottom: 5px;">${achievement.icon} ACHIEVEMENT UNLOCKED!</div>
                <div style="font-size: 1.2em; margin-bottom: 5px;">${achievement.name}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">${achievement.desc}</div>
                <div style="font-size: 1.1em; margin-top: 10px; color: #ffd700;">+${achievement.points} points!</div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 4500);
            
            if (gameState.isAudioEnabled) {
                playBeep(880, 0.3);
                setTimeout(() => playBeep(1100, 0.3), 100);
                setTimeout(() => playBeep(1320, 0.4), 200);
            }
        }

        function updateAchievementsDisplay() {
            elements.achievementsList.innerHTML = '';
            gameState.achievements.forEach(achievement => {
                const div = document.createElement('div');
                div.className = `achievement ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                div.innerHTML = `
                    <span style="font-size: 1.2em;">${achievement.icon}</span>
                    <div>
                        <div style="font-weight: bold;">${achievement.name}</div>
                        <div style="font-size: 0.8em; opacity: 0.8;">${achievement.desc}</div>
                    </div>
                    <span style="margin-left: auto; font-weight: bold;">+${achievement.points}</span>
                `;
                elements.achievementsList.appendChild(div);
            });
        }

        // === MULTIPLIER & LIVES SYSTEM ===
        function updateMultiplier() {
            let newMultiplier = 1;
            if (gameState.streak >= 10) newMultiplier = 3;
            else if (gameState.streak >= 5) newMultiplier = 2;
            else if (gameState.streak >= 3) newMultiplier = 1.5;
            
            if (newMultiplier !== gameState.multiplier) {
                gameState.multiplier = newMultiplier;
                elements.multiplierValue.textContent = `${newMultiplier}x`;
                elements.multiplierDisplay.classList.add('active');
                setTimeout(() => elements.multiplierDisplay.classList.remove('active'), 500);
            }
        }

        function updateLivesDisplay() {
            const hearts = [];
            for (let i = 0; i < CONFIG.STARTING_LIVES; i++) {
                hearts.push(`<span class="life-heart ${i < gameState.lives ? '' : 'lost'}">${i < gameState.lives ? '❤️' : '💔'}</span>`);
            }
            elements.livesHearts.innerHTML = hearts.join('');
        }

        // === GAME LOGIC ===
        function getCurrentLocations() {
            const modeMap = {
                'countries': gameData.countries,
                'us-states': gameData.usStates,
                'world-cities': gameData.worldCities,
                'european-countries': gameData.europeanCountries,
                'asian-countries': gameData.asianCountries
            };
            return modeMap[gameState.gameMode] || gameData.countries;
        }

        function selectRandomLocation() {
            const locations = getCurrentLocations();
            if (locations.length === 0) return null;
            
            let newLocation;
            do {
                newLocation = locations[Math.floor(Math.random() * locations.length)];
            } while (newLocation === gameState.currentLocation && locations.length > 1);
            
            return newLocation;
        }

        function startRound() {
            cleanupMarkers();
            
            gameState.currentLocation = selectRandomLocation();
            if (!gameState.currentLocation) {
                alert('No locations available for this mode! Try the "World Countries" mode.');
                return;
            }

            gameState.roundStartTime = Date.now();
            elements.targetName.textContent = gameState.currentLocation.name;
            elements.resultOverlay.style.display = 'none';
            
            if (gameState.gameMode === 'us-states') leafletMap.setView([39.8283, -98.5795], 4);
            else if (gameState.gameMode === 'european-countries') leafletMap.setView([54.5260, 15.2551], 4);
            else if (gameState.gameMode === 'asian-countries') leafletMap.setView([34.0479, 100.6197], 3);
            else leafletMap.setView([20, 0], 2);
            
            startTimer();
            updateUI();
        }

        function startTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timeLeft = CONFIG.DIFFICULTY_SETTINGS[gameState.difficulty].time;
            elements.timerDisplay.textContent = gameState.timeLeft;
            elements.timerDisplay.classList.remove('warning');
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                elements.timerDisplay.textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 10) elements.timerDisplay.classList.add('warning');
                if (gameState.timeLeft <= 0) handleTimeout();
            }, 1000);
        }

        function handleGuess(coords) {
            clearInterval(gameState.timerInterval);
            const distance = calculateDistance(coords.lat, coords.lng, gameState.currentLocation.coords[0], gameState.currentLocation.coords[1]);
            processGuess(coords, distance);
        }

        function handleTimeout() {
            clearInterval(gameState.timerInterval);
            processGuess({ lat: 0, lng: 0 }, 20000, true);
        }

        function processGuess(guessCoords, distance, isTimeout = false) {
            const maxDistance = 20000;
            const accuracy = Math.max(0, (maxDistance - distance) / maxDistance * 100);
            const baseScore = Math.round((maxDistance - distance) / maxDistance * CONFIG.MAX_SCORE_PER_ROUND);
            const difficultyMultiplier = CONFIG.DIFFICULTY_SETTINGS[gameState.difficulty].multiplier;
            let roundScore = Math.round(baseScore * difficultyMultiplier * gameState.multiplier);
            
            gameState.totalGuesses++;
            gameState.accuracyHistory.push(accuracy);
            
            const isCorrect = accuracy > 25 && !isTimeout;
            
            if (isCorrect) {
                gameState.totalCorrect++;
                gameState.streak++;
                if (accuracy >= 95) gameState.perfectStreak++;
                else gameState.perfectStreak = 0;
                
                gameState.totalScore += roundScore;
                showFloatingScore(roundScore);
            } else {
                const penalty = isTimeout ? CONFIG.DIFFICULTY_SETTINGS[gameState.difficulty].wrongPenalty : CONFIG.WRONG_PENALTY;
                gameState.totalScore -= penalty;
                gameState.streak = 0;
                gameState.perfectStreak = 0;
                gameState.multiplier = 1;
                gameState.lives--;
                
                showFloatingScore(-penalty);
                if (gameState.isAudioEnabled) playBeep(150, 0.8);
            }
            
            updateMultiplier();
            updateLivesDisplay();
            checkAchievements();
            
            if (gameState.isAudioEnabled && isCorrect) {
                if (accuracy > 90) playBeep(880, 0.2);
                else if (accuracy > 60) playBeep(660, 0.3);
                else playBeep(440, 0.4);
            }
            
            if (gameState.lives <= 0 || gameState.totalScore <= 0) {
                gameState.totalScore = Math.max(0, gameState.totalScore);
                showGameOver();
                return;
            }
            
            showRoundResult(guessCoords, distance, isCorrect ? roundScore : -CONFIG.WRONG_PENALTY, accuracy, isTimeout);
        }

        function showFloatingScore(score) {
            const scoreElement = document.createElement('div');
            scoreElement.className = `score-change ${score >= 0 ? 'score-positive' : 'score-negative'}`;
            scoreElement.textContent = `${score >= 0 ? '+' : ''}${score}`;
            document.body.appendChild(scoreElement);
            setTimeout(() => {
                if (scoreElement.parentNode) scoreElement.parentNode.removeChild(scoreElement);
            }, 2000);
        }

        function showRoundResult(guessCoords, distance, score, accuracy, isTimeout) {
            const answerCoords = gameState.currentLocation.coords;
            
            if (!isTimeout) {
                guessMarker = L.marker([guessCoords.lat, guessCoords.lng]).addTo(leafletMap);
            }
            
            answerMarker = L.marker(answerCoords, {
                icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                })
            }).addTo(leafletMap);
            
            if (!isTimeout) {
                const color = accuracy > 75 ? '#39ff14' : accuracy > 50 ? '#00f5ff' : '#ff073a';
                resultLine = L.polyline([[guessCoords.lat, guessCoords.lng], answerCoords], { color, weight: 3, opacity: 0.8 }).addTo(leafletMap);
                leafletMap.fitBounds(resultLine.getBounds().pad(0.2));
            } else {
                leafletMap.setView(answerCoords, 6);
            }
            
            elements.resultDistance.textContent = isTimeout ? 'Time\'s Up!' : `${Math.round(distance)} km away`;
            elements.resultScoreText.textContent = `Score: ${score >= 0 ? '+' : ''}${score}`;
            elements.resultScoreText.style.color = score >= 0 ? (gameState.isDarkTheme ? 'var(--dark-success)' : 'var(--light-success)') : (gameState.isDarkTheme ? 'var(--dark-danger)' : 'var(--light-danger)');
            elements.resultAccuracy.textContent = `Accuracy: ${accuracy.toFixed(1)}%`;
            
            elements.resultOverlay.style.display = 'block';
            updateUI();
        }

        function cleanupMarkers() {
            if (guessMarker) leafletMap.removeLayer(guessMarker);
            if (answerMarker) leafletMap.removeLayer(answerMarker);
            if (resultLine) leafletMap.removeLayer(resultLine);
            guessMarker = answerMarker = resultLine = null;
        }

        function nextRound() {
            gameState.round++;
            startRound();
        }

        function skipRound() {
            gameState.totalScore -= CONFIG.SKIP_PENALTY;
            gameState.streak = 0;
            gameState.multiplier = 1;
            showFloatingScore(-CONFIG.SKIP_PENALTY);
            
            if (gameState.totalScore <= 0) {
                gameState.totalScore = 0;
                showGameOver();
            } else {
                nextRound();
            }
        }

        function showGameOver() {
            clearInterval(gameState.timerInterval);
            
            const highScoreKey = `highScore_${gameState.gameMode}_${gameState.difficulty}`;
            const currentHighScore = parseInt(localStorage.getItem(highScoreKey)) || 0;
            
            if (gameState.totalScore > currentHighScore) {
                localStorage.setItem(highScoreKey, gameState.totalScore);
                elements.highScoreMessage.style.display = 'block';
            } else {
                elements.highScoreMessage.style.display = 'none';
            }
            
            const unlockedAchievements = gameState.achievements.filter(a => a.unlocked);
            elements.finalAchievements.innerHTML = `
                <h3>Achievement Summary</h3>
                <p>Unlocked: ${unlockedAchievements.length}/${gameState.achievements.length}</p>
                <p>Accuracy: ${gameState.totalGuesses > 0 ? Math.round((gameState.totalCorrect / gameState.totalGuesses) * 100) : 0}%</p>
            `;
            
            elements.finalScore.textContent = gameState.totalScore;
            elements.gameOverScreen.style.display = 'block';
        }

        function shareScore() {
            const text = `🌍 I scored ${gameState.totalScore} in GeoChallenge Ultimate! Mode: ${gameState.gameMode}, Rounds: ${gameState.round - 1}. Can you beat me? 🏆`;
            if (navigator.share) {
                navigator.share({ title: 'GeoChallenge Ultimate Score', text, url: window.location.href });
            } else {
                navigator.clipboard.writeText(text).then(() => alert('Score copied to clipboard!'));
            }
        }

        function resetGame() {
            gameState.totalScore = CONFIG.STARTING_SCORE;
            gameState.round = 1;
            gameState.streak = 0;
            gameState.lives = CONFIG.STARTING_LIVES;
            gameState.multiplier = 1;
            gameState.perfectStreak = 0;
            gameState.totalCorrect = 0;
            gameState.totalGuesses = 0;
            gameState.accuracyHistory = [];
            
            elements.gameOverScreen.style.display = 'none';
            cleanupMarkers();
            updateUI();
            updateAchievementsDisplay();
            startRound();
        }

        function updateUI() {
            elements.currentScore.textContent = gameState.totalScore;
            elements.roundCounter.textContent = gameState.round;
            elements.streakCounter.textContent = gameState.streak;
            elements.multiplierValue.textContent = `${gameState.multiplier}x`;
            
            const highScoreKey = `highScore_${gameState.gameMode}_${gameState.difficulty}`;
            elements.highScore.textContent = parseInt(localStorage.getItem(highScoreKey)) || 0;
            
            updateLivesDisplay();
        }

        function toggleTheme() {
            gameState.isDarkTheme = !gameState.isDarkTheme;
            document.body.className = gameState.isDarkTheme ? 'dark-theme' : 'light-theme';
            elements.themeToggle.textContent = gameState.isDarkTheme ? '☀️ Day Mode' : '🌙 Night Mode';
            
            if (gameState.isDarkTheme) {
                if (leafletMap.hasLayer(lightTileLayer)) leafletMap.removeLayer(lightTileLayer);
                if (!leafletMap.hasLayer(darkTileLayer)) leafletMap.addLayer(darkTileLayer);
            } else {
                if (leafletMap.hasLayer(darkTileLayer)) leafletMap.removeLayer(darkTileLayer);
                if (!leafletMap.hasLayer(lightTileLayer)) leafletMap.addLayer(lightTileLayer);
            }
            localStorage.setItem('theme', gameState.isDarkTheme ? 'dark' : 'light');
        }

        function toggleAudio() {
            gameState.isAudioEnabled = !gameState.isAudioEnabled;
            elements.audioToggle.textContent = gameState.isAudioEnabled ? '🔊 Audio' : '🔇 Muted';
            if (gameState.isAudioEnabled) {
                elements.ambientAudio.play().catch(e => {});
            } else {
                elements.ambientAudio.pause();
            }
            localStorage.setItem('audioEnabled', gameState.isAudioEnabled);
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        // === AUDIO SYSTEM ===
        let audioContext;
        function initAudio() {
            if (!gameState.isAudioEnabled) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                elements.ambientAudio.volume = 0.3;
                elements.ambientAudio.play().catch(e => {});
            } catch (error) {
                console.warn('Audio not supported:', error);
            }
        }

        function playBeep(frequency, duration) {
            if (!gameState.isAudioEnabled || !audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            osc.start();
            osc.stop(audioContext.currentTime + duration);
        }

        // === EVENT LISTENERS ===
        elements.themeToggle.addEventListener('click', toggleTheme);
        elements.gameModeSelect.addEventListener('change', (e) => {
            gameState.gameMode = e.target.value;
            if (!gameState.playedModes.includes(e.target.value)) gameState.playedModes.push(e.target.value);
            resetGame();
        });
        elements.difficultySelect.addEventListener('change', (e) => {
            gameState.difficulty = e.target.value;
            resetGame(); // Reset on difficulty change to update high score display and timer
        });
        elements.audioToggle.addEventListener('click', toggleAudio);
        elements.nextRoundBtn.addEventListener('click', nextRound);
        elements.skipRoundBtn.addEventListener('click', skipRound);
        elements.restartBtn.addEventListener('click', resetGame);
        elements.shareScoreBtn.addEventListener('click', shareScore);
        elements.modeChangeBtn.addEventListener('click', () => {
            elements.gameOverScreen.style.display = 'none';
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' && elements.resultOverlay.style.display === 'block') { e.preventDefault(); nextRound(); }
            if (e.key === 's' && elements.resultOverlay.style.display === 'block') { e.preventDefault(); skipRound(); }
            if (e.key === 'r' && elements.gameOverScreen.style.display === 'block') { e.preventDefault(); resetGame(); }
        });
        
        function saveAchievements() {
            localStorage.setItem('achievements', JSON.stringify(gameState.achievements.filter(a => a.unlocked)));
        }

        // === INITIALIZATION ===
        async function initGame() {
            try {
                // Load saved preferences
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    gameState.isDarkTheme = savedTheme === 'dark';
                    document.body.className = gameState.isDarkTheme ? 'dark-theme' : 'light-theme';
                    elements.themeToggle.textContent = gameState.isDarkTheme ? '☀️ Day Mode' : '🌙 Night Mode';
                }
                
                const savedAudio = localStorage.getItem('audioEnabled');
                if (savedAudio !== null) {
                    gameState.isAudioEnabled = savedAudio === 'true';
                    elements.audioToggle.textContent = gameState.isAudioEnabled ? '🔊 Audio' : '🔇 Muted';
                }

                // Load saved achievements
                const savedAchievements = JSON.parse(localStorage.getItem('achievements') || '[]');
                savedAchievements.forEach(savedAch => {
                    const gameAch = gameState.achievements.find(a => a.id === savedAch.id);
                    if (gameAch) gameAch.unlocked = true;
                });
                
                initLeaflet();
                await loadGameData(); // Await the data loading
                
                elements.loadingScreen.style.display = 'none';
                elements.mapContainer.classList.add('loaded');
                
                document.addEventListener('click', () => { if (!audioContext) initAudio(); }, { once: true });
                
                updateAchievementsDisplay();
                resetGame();
                
            } catch (error) {
                console.error('Initialization failed:', error);
                elements.loadingStatus.textContent = 'Initialization failed. Please refresh the page.';
            }
        }

        // Start the game
        initGame();
    </script>
</body>
</html>
